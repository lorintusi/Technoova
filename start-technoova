#!/bin/bash

# Technoova Planner - Start Script
# Startet alle benÃ¶tigten Services

# Farben fÃ¼r Output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  Technoova Planner wird gestartet...${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# Projektverzeichnis
PROJECT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$PROJECT_DIR"

# PID-Datei fÃ¼r den Server
PID_FILE="$PROJECT_DIR/.technoova.pid"

# PrÃ¼fen ob Server bereits lÃ¤uft
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE")
  if ps -p $PID > /dev/null 2>&1; then
    echo -e "${YELLOW}âš ï¸  Server lÃ¤uft bereits (PID: $PID)${NC}"
    echo -e "${YELLOW}   URL: http://localhost:8080${NC}"
    echo ""
    echo -e "${YELLOW}   Zum Stoppen: ./stop-technoova${NC}"
    exit 1
  else
    # PID-Datei existiert aber Prozess lÃ¤uft nicht mehr
    rm -f "$PID_FILE"
  fi
fi

# PrÃ¼fen ob Port 8080 bereits belegt ist
if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null 2>&1 ; then
  echo -e "${RED}âŒ Port 8080 ist bereits belegt!${NC}"
  echo ""
  echo "Belegte Prozesse:"
  lsof -i :8080
  echo ""
  echo -e "${YELLOW}Tipp: Stoppe den Prozess mit:${NC}"
  echo "  kill -9 \$(lsof -ti:8080)"
  exit 1
fi

# Node.js Version prÃ¼fen
if ! command -v node &> /dev/null; then
  echo -e "${RED}âŒ Node.js ist nicht installiert!${NC}"
  echo "   Bitte installieren: https://nodejs.org/"
  exit 1
fi

NODE_VERSION=$(node -v)
echo -e "${GREEN}âœ“ Node.js gefunden:${NC} $NODE_VERSION"

# Data-Verzeichnis erstellen falls nicht vorhanden
if [ ! -d "$PROJECT_DIR/data" ]; then
  mkdir -p "$PROJECT_DIR/data"
  echo -e "${GREEN}âœ“ Data-Verzeichnis erstellt${NC}"
fi

# Server im Hintergrund starten
echo ""
echo -e "${YELLOW}ğŸš€ Starte Technoova Server...${NC}"
echo ""

# Server starten und Output in Logfile schreiben
LOG_FILE="$PROJECT_DIR/technoova.log"
nohup npm start > "$LOG_FILE" 2>&1 &
SERVER_PID=$!

# PID speichern
echo $SERVER_PID > "$PID_FILE"

# Kurz warten bis Server gestartet ist
sleep 2

# PrÃ¼fen ob Server lÃ¤uft
if ps -p $SERVER_PID > /dev/null; then
  echo -e "${GREEN}========================================${NC}"
  echo -e "${GREEN}âœ… Technoova Planner erfolgreich gestartet!${NC}"
  echo -e "${GREEN}========================================${NC}"
  echo ""
  echo -e "${GREEN}ğŸ“ URL:${NC}        http://localhost:8080"
  echo -e "${GREEN}ğŸ”‘ Admin:${NC}      admin / 010203"
  echo -e "${GREEN}ğŸ‘¤ Test-User:${NC}  test1 / 010203"
  echo -e "${GREEN}ğŸ“ Log-Datei:${NC}  $LOG_FILE"
  echo -e "${GREEN}ğŸ”¢ PID:${NC}        $SERVER_PID"
  echo ""
  echo -e "${YELLOW}ğŸ’¡ Tipp: Log-Ausgabe anzeigen:${NC}"
  echo "   tail -f technoova.log"
  echo ""
  echo -e "${YELLOW}ğŸ›‘ Zum Stoppen:${NC}"
  echo "   ./stop-technoova"
  echo ""
else
  echo -e "${RED}âŒ Server konnte nicht gestartet werden!${NC}"
  echo "   Siehe Log: $LOG_FILE"
  rm -f "$PID_FILE"
  exit 1
fi
