# ERP-AUDIT REPORT
**Datum:** 2026-01-20  
**Auditor:** Senior IT-Architekt / ERP-Experte / Code-Auditor  
**System:** LoomOne Zeitplanungs- und Zeiterfassungssystem  
**Ziel:** PrÃ¼fung auf ERP-Tauglichkeit, Single Source of Truth, Konsistenz

---

## EXECUTIVE SUMMARY

Das System zeigt **grundlegende ERP-FunktionalitÃ¤t**, hat jedoch **kritische Inkonsistenzen** in der User/Worker-Identifikation, doppelte Berechnungslogik fÃ¼r Stunden, und uneinheitliche Status-Behandlung. **ERP Readiness Score: 62/100**.

**Top 5 Critical Findings:**
1. **CRITICAL:** Doppelte User-Identifikation (`worker_id` vs `user_id` vs `created_by`) fÃ¼hrt zu inkonsistenten Filtern und mÃ¶glichen Datenlecks
2. **CRITICAL:** Zwei verschiedene Stunden-Berechnungsfunktionen (`computeHours` vs `minutesBetween` vs `calculateHours`) mit unterschiedlicher Logik
3. **HIGH:** `getActiveCalendarUserId()` und `getCalendarViewUserId()` haben Ã¼berlappende, aber unterschiedliche Logik
4. **HIGH:** Status-Defaults sind uneinheitlich (Backend: `PLANNED`, Frontend: teilweise `PLANNED`, teilweise Fallback)
5. **MEDIUM:** Admin Overview aggregiert Stunden anders als Day/Week View (potenzielle Zahlenabweichungen)

---

## PHASE 1 â€” MODUL-LANDKARTE

### Frontend Module (app.js, 9373 Zeilen)

| Modul | Hauptfunktionen | Verantwortlichkeiten | Zeilen |
|--------|----------------|---------------------|--------|
| **Auth/User Management** | `checkCurrentSession()`, `loadAllData()`, `handleLogin()` | Session-Management, User-Loading | ~200-400 |
| **UI State Management** | `uiState` object, `renderApp()` | Globaler UI-State, Rendering-Orchestrierung | ~280-310, ~500-600 |
| **Kalender Views** | `renderDayView()`, `renderWeekTimeGrid()`, `renderMonthView()`, `renderYearView()` | Day/Week/Month/Year Ansichten | ~2913-3100, ~4687-5200, ~2624-2760 |
| **Zeiterfassung Wizard** | `renderTimeEntryWizard()`, `saveTimeEntryFromWizard()` | Zeitplanung/Erfassung via Multi-Step Wizard | ~8832-9373 |
| **BestÃ¤tigung** | `confirmDay()`, Event-Handler fÃ¼r `confirm-day` | Batch-BestÃ¤tigung von PLANNED EintrÃ¤gen | ~2400-2450, ~2214-2233 |
| **Kategorien/AktivitÃ¤ten Panel** | In `renderDayView()`: `categoryTotals` | Summen pro Kategorie/Projekt | ~2970-2976 |
| **TeamÃ¼bersicht (Admin)** | `renderAdminOverview()`, Admin Overview Grid | WochenÃ¼bersicht aller Mitarbeiter | ~5200-6000 (geschÃ¤tzt) |
| **Mitarbeiter-Kalender Ansicht** | `renderEmployeeCalendarModal()`, `getCalendarViewUserId()` | Admin kann einzelne Mitarbeiter-Kalender anzeigen | ~8792-8830, ~2472-2478 |
| **API Client** | `api` object (request, get, post, put, delete) | REST API Kommunikation | ~1-200 |
| **Time Entry Service** | `loadTimeEntries()`, `validateTimeEntry()`, `calculateDuration()` | Laden, Validierung, Berechnungen | ~8232-8300, ~7993-8017 |

### Backend Module (PHP)

| Modul | Datei | Verantwortlichkeiten | Zeilen |
|-------|-------|---------------------|--------|
| **API Router** | `backend/api/index.php` | Request-Routing, Auth-Check | ~1-213 |
| **Auth** | `backend/api/auth.php` | Login, Session-Management | - |
| **Time Entries** | `backend/api/time_entries.php` | CRUD, Confirm/Reject, Overlap-Validation | ~1-603 |
| **Admin Overview** | `backend/api/admin_overview.php` | WochenÃ¼bersicht Aggregation | ~1-183 |
| **Users** | `backend/api/users.php` | User-Management | - |
| **Workers** | `backend/api/workers.php` | Worker-Management | - |
| **Locations** | `backend/api/locations.php` | Projekt/Baustellen-Management | - |
| **Services** | `backend/services/TimeEntryService.php` | Business-Logik (teilweise ungenutzt?) | - |

### Datenbank Schema

| Tabelle | Hauptfelder | Verantwortlichkeiten |
|---------|-------------|---------------------|
| `users` | `id`, `worker_id`, `weekly_hours_target`, `role`, `permissions` | User-Accounts, Rollen, Targets |
| `workers` | `id`, `name` | Mitarbeiter-Stammdaten |
| `time_entries` | `id`, `worker_id`, `user_id` (via `created_by`), `entry_date`, `time_from`, `time_to`, `hours`, `status`, `planned_by`, `confirmed_by`, `confirmed_at` | Zeit-EintrÃ¤ge, Status-Workflow |
| `locations` | `id`, `code`, `address` | Projekte/Baustellen |

---

## PHASE 2 â€” ENTITÃ„TEN-LANDKARTE

### Core Entities

| EntitÃ¤t | DB-Tabelle | Frontend ReprÃ¤sentation | Backend API |
|---------|------------|-------------------------|--------------|
| **User** | `users` | `data.users[]`, `data.currentUser` | `GET/POST/PUT/DELETE /api/users` |
| **Worker** | `workers` | `data.workers[]` | `GET/POST/PUT/DELETE /api/workers` |
| **Time Entry** | `time_entries` | `data.timeEntries[]` | `GET/POST/PUT/DELETE /api/time_entries`, `POST /api/time_entries/confirm_day` |
| **Location/Project** | `locations` | `data.locations[]` | `GET/POST/PUT/DELETE /api/locations` |
| **Category** | (Hardcoded) | `standardCategories[]`, `projectCategories[]` | - |

### Entity Lifecycle States

**Time Entry Status:**
- `PLANNED`: Geplant (Admin oder selbst eingegeben)
- `CONFIRMED`: BestÃ¤tigt (vom Mitarbeiter oder Admin fÃ¼r sich selbst)
- `REJECTED`: Abgelehnt (optional)

**Status-Transitions:**
- `PLANNED` â†’ `CONFIRMED` (via `confirm_day` oder `confirm` single)
- `PLANNED` â†’ `REJECTED` (via `reject` single)
- `CONFIRMED` â†’ (keine RÃ¼cknahme definiert - **RISIKO**)

---

## PHASE 3 â€” FINDINGS: DUPLIKATE / WIDERSPRÃœCHE / LÃœCKEN

### ğŸ”´ CRITICAL: Doppelte User-Identifikation (worker_id vs user_id vs created_by)

**Problem:** Das System verwendet drei verschiedene Wege, um einen User/Mitarbeiter zu identifizieren:
1. `worker_id` (wenn User einem Worker zugeordnet ist)
2. `user_id` (direkt, wenn kein worker_id)
3. `created_by` (als Fallback)

**Belege:**

**Backend (`backend/api/time_entries.php`):**
- Zeile 25-42: `handleConfirmDay()` prÃ¼ft `worker_id` ODER `created_by`
- Zeile 140-149: `handleGetTimeEntries()` filtert via `worker_id` ODER `created_by`
- Zeile 223-241: `handleCreateTimeEntry()` akzeptiert `worker_id` ODER `user_id` (konvertiert zu worker_id)
- Zeile 264-295: Overlap-Check verwendet `worker_id` ODER `created_by`

**Frontend (`app.js`):**
- Zeile 8234-8237: `loadTimeEntries()` verwendet `viewUser?.workerId` ODER `calendarViewUserId`
- Zeile 2926-2942: `renderDayView()` filtert via `activeDayWorkerId` ODER `activeDayUserId`
- Zeile 2936-2940: Vergleich mit `norm(entry.worker_id)` ODER `norm(entry.user_id)`

**Risiko:**
- **Datenleck:** Wenn ein Entry `worker_id = NULL` und `created_by = UserA` hat, aber ein anderer Filter nur `worker_id` prÃ¼ft, wird der Entry nicht gefunden
- **Inkonsistente Filter:** Admin Overview (Zeile 73-74 in `admin_overview.php`) filtert nur nach `worker_id`, ignoriert `created_by`-Entries
- **BestÃ¤tigung:** `confirm_day` kÃ¶nnte Entries Ã¼bersehen, wenn `worker_id` fehlt

**Konkretes Beispiel:**
```php
// backend/api/admin_overview.php:73-74
$userEntries = array_filter($entries, function($e) use ($workerId) {
    return $e['worker_id'] === $workerId; // âŒ Ignoriert created_by-Entries!
});
```

---

### ğŸ”´ CRITICAL: Doppelte Stunden-Berechnungslogik

**Problem:** Es existieren **drei verschiedene Funktionen** zur Berechnung von Stunden aus `time_from`/`time_to`:

1. **Backend:** `calculateHours($timeFrom, $timeTo)` - `backend/api/time_entries.php:589-602`
   - Behandelt Tag-Ãœbergang (addiert 24h wenn negativ)
   - Rundet auf 2 Dezimalstellen

2. **Frontend Day View:** `computeHours(entry)` - `app.js:2945-2961`
   - Berechnet nur `(endMinutes - startMinutes) / 60`
   - **KEIN Tag-Ãœbergang** (kann negativ werden bei 23:00-01:00)
   - Fallback auf `entry.hours` wenn Parsing fehlschlÃ¤gt

3. **Frontend Week View:** `minutesBetween(timeFrom, timeTo)` - `app.js:3484-3493`
   - Verwendet `Date`-Objekte
   - Kann Tag-Ãœbergang korrekt behandeln (wenn `to > from`)

**Belege:**
- `backend/api/time_entries.php:589-602`: `calculateHours()` mit Tag-Ãœbergang
- `app.js:2945-2961`: `computeHours()` ohne Tag-Ãœbergang
- `app.js:3484-3493`: `minutesBetween()` mit Date-Objekten
- `app.js:4752`: Week View verwendet `minutesBetween()`
- `app.js:2963-2966`: Day View verwendet `computeHours()`

**Risiko:**
- **Falsche Summen:** Nacht-Schichten (z.B. 23:00-01:00) werden in Day View falsch berechnet
- **Inkonsistente Zahlen:** Day View und Week View kÃ¶nnen unterschiedliche Summen fÃ¼r denselben Tag zeigen
- **Backend vs Frontend:** Backend speichert `hours` mit Tag-Ãœbergang, Frontend rechnet teilweise neu (ohne Tag-Ãœbergang)

**Konkretes Beispiel:**
```javascript
// app.js:2945-2961 - computeHours() fÃ¼r Day View
const computeHours = (entry) => {
  const startMinutes = startH * 60 + startM;
  const endMinutes = endH * 60 + endM;
  const durationMinutes = endMinutes - startMinutes; // âŒ Negativ bei 23:00-01:00!
  return durationMinutes / 60;
};
```

vs.

```php
// backend/api/time_entries.php:596-598
$diffMinutes = $toMinutes - $fromMinutes;
if ($diffMinutes < 0) {
    $diffMinutes += 24 * 60; // âœ… Tag-Ãœbergang behandelt
}
```

---

### ğŸŸ  HIGH: Doppelte User-View-Filter-Logik

**Problem:** Es existieren **zwei Ã¤hnliche, aber unterschiedliche Funktionen** zur Bestimmung des aktiven Users fÃ¼r Kalender-Ansichten:

1. **`getActiveCalendarUserId()`** - `app.js:2463-2470`
   - Gibt `calendarViewUserId` zurÃ¼ck, wenn Admin UND gesetzt
   - Sonst `currentUser.id`
   - **Kommentar:** "for admin planning: selectedUserId"

2. **`getCalendarViewUserId()`** - `app.js:2472-2478`
   - Gibt `calendarViewUserId` zurÃ¼ck, wenn Admin UND gesetzt
   - Sonst `currentUser.id`
   - **Kommentar:** "for viewing only (not planning)"

**Belege:**
- `app.js:2463-2470`: `getActiveCalendarUserId()` (wird verwendet in Zeile 2009)
- `app.js:2472-2478`: `getCalendarViewUserId()` (wird verwendet in Zeile 2926, 4731, 8234)
- `app.js:2009`: Verwendet `getActiveCalendarUserId()` (veraltet?)
- `app.js:2926, 4731, 8234`: Verwenden `getCalendarViewUserId()` (aktuell)

**Risiko:**
- **Verwirrung:** Zwei Funktionen mit fast identischer Logik, aber unterschiedlichen Namen
- **Inkonsistenz:** Wenn eine Funktion geÃ¤ndert wird, muss die andere auch angepasst werden
- **Veraltete Verwendung:** Zeile 2009 verwendet noch `getActiveCalendarUserId()`, sollte auf `getCalendarViewUserId()` umgestellt werden

---

### ğŸŸ  HIGH: Uneinheitliche Status-Defaults

**Problem:** Der Default-Status fÃ¼r neue Time Entries ist nicht konsistent definiert:

**Backend:**
- `backend/api/time_entries.php:307`: `$status = isset($data['status']) ? $data['status'] : 'PLANNED';`
- âœ… Konsistent: Immer `PLANNED` wenn nicht gesetzt

**Frontend:**
- `app.js:9296`: `const status = isAdmin ? 'PLANNED' : 'PLANNED';` (immer PLANNED)
- `app.js:4759`: `const status = entry.status || 'PLANNED';` (Fallback)
- `app.js:3845`: `const status = entry.status || 'PLANNED';` (Fallback)

**Risiko:**
- **Niedrig:** Frontend setzt Status korrekt, aber Fallbacks kÃ¶nnten bei fehlendem Feld zu Problemen fÃ¼hren
- **Potenzial:** Wenn Backend mal `NULL` zurÃ¼ckgibt (trotz NOT NULL Constraint), wÃ¼rde Frontend `PLANNED` annehmen

---

### ğŸŸ¡ MEDIUM: Admin Overview vs Day/Week View - Unterschiedliche Aggregation

**Problem:** Admin Overview aggregiert Stunden anders als Day/Week View:

**Admin Overview (`backend/api/admin_overview.php:92-99`):**
```php
$hours = (float)$entry['hours']; // Verwendet gespeichertes hours-Feld
$days[$day]['hours'] += $hours;
if ($entry['status'] === 'PLANNED') {
    $days[$day]['planned'] += $hours;
} elseif ($entry['status'] === 'CONFIRMED') {
    $days[$day]['confirmed'] += $hours;
}
```

**Day View (`app.js:2963-2966`):**
```javascript
const computeHours = (entry) => { /* berechnet aus time_from/time_to */ };
const dayTotal = dayTimeEntries.reduce((sum, entry) => sum + computeHours(entry), 0);
const confirmedHours = dayTimeEntries
  .filter(entry => entry.status === 'CONFIRMED')
  .reduce((sum, entry) => sum + computeHours(entry), 0);
```

**Risiko:**
- **Zahlenabweichungen:** Wenn `hours`-Feld im Backend nicht mit `time_from/time_to` Ã¼bereinstimmt (z.B. nach manueller Ã„nderung), zeigen Overview und Day View unterschiedliche Summen
- **Vertrauensverlust:** Admin sieht in Overview andere Zahlen als in Day View

---

### ğŸŸ¡ MEDIUM: Overlap-Validation - Unterschiedliche Logik Frontend vs Backend

**Problem:** Frontend und Backend haben unterschiedliche Overlap-Validierung:

**Backend (`backend/api/time_entries.php:265-295`):**
```php
// PrÃ¼ft: time_from < new_end AND time_to > new_start
WHERE time_from < ? AND time_to > ?
```

**Frontend (`app.js:7993-8017`):**
```javascript
// PrÃ¼ft: fromMinutes < entryToMinutes && toMinutes > entryFromMinutes
if ((fromMinutes < entryToMinutes && toMinutes > entryFromMinutes)) {
  return { valid: false, error: '...' };
}
```

**Beide sind korrekt**, aber:
- Frontend verwendet `calculateDuration()` (Zeile 7976-7982), die fehlerhaft ist (siehe unten)
- Backend verwendet direkte String-Vergleiche (`time_from < time_to`)

**ZusÃ¤tzliches Problem:** `calculateDuration()` in `app.js:7976-7982`:
```javascript
function calculateDuration(timeFrom, timeTo) {
  const from = new Date(`2000-01-01T${timeFrom}:00`);
  const to = new Date(`2000-01-01T${timeTo}:00`);
  if (to <= from) return 0; // âŒ Falsch: sollte Tag-Ãœbergang behandeln
  return (to - from) / (1000 * 60);
}
```

**Risiko:**
- **Frontend-Validierung kann fehlschlagen:** Bei Tag-Ãœbergang (23:00-01:00) gibt `calculateDuration()` 0 zurÃ¼ck, Overlap-Check funktioniert nicht
- **Inkonsistenz:** Backend wÃ¼rde Overlap korrekt erkennen, Frontend nicht

---

### ğŸŸ¡ MEDIUM: `selectedUserId` vs `calendarViewUserId` - Verwirrende Trennung

**Problem:** Es existieren zwei Ã¤hnliche UI-State-Variablen:
- `uiState.selectedUserId` (Zeile 300): "Selected user for admin view (null = current user)"
- `uiState.calendarViewUserId` (Zeile 301): "User ID whose calendar is being viewed (null = own calendar, admin only)"

**Belege:**
- `app.js:300`: `selectedUserId: null`
- `app.js:301`: `calendarViewUserId: null`
- `app.js:1995, 2004, 2006`: `selectedUserId` wird gesetzt (veraltet?)
- `app.js:2224, 2230, 2250`: `calendarViewUserId` wird gesetzt (aktuell)

**Risiko:**
- **Verwirrung:** Zwei Variablen fÃ¼r Ã¤hnlichen Zweck
- **Veralteter Code:** `selectedUserId` wird noch verwendet, sollte auf `calendarViewUserId` konsolidiert werden

---

### ğŸŸ¢ LOW: Fehlende Audit-Trail-Konsistenz

**Problem:** `confirmed_at` und `confirmed_by` werden nicht immer gesetzt:

**Belege:**
- `backend/api/time_entries.php:47-50`: `confirm_day` setzt beide âœ…
- `backend/api/time_entries.php:540-543`: `handleConfirmTimeEntry()` setzt beide âœ…
- `backend/api/time_entries.php:577`: `handleRejectTimeEntry()` setzt **KEIN** `rejected_at` oder `rejected_by` âŒ

**Risiko:**
- **Niedrig:** Rejected-Entries haben keinen Audit-Trail (wer hat wann abgelehnt?)

---

## PHASE 4 â€” WORKFLOW-AUDIT

### Workflow 1: Admin plant Zeit fÃ¼r Mitarbeiter

**Happy Path:**
1. Admin Ã¶ffnet Wizard (`renderTimeEntryWizard()`)
2. Admin wÃ¤hlt Mitarbeiter im Dropdown (`wizard-user` select)
3. Admin fÃ¼llt Datum, Zeit, Kategorie, Projekt aus
4. `saveTimeEntryFromWizard()` wird aufgerufen
5. Frontend bestimmt `activeWorkerId`/`activeUserId` aus Wizard-Select (Zeile 9235-9239)
6. Backend erhÃ¤lt `worker_id` oder `user_id` im Payload
7. Backend erstellt Entry mit `status = 'PLANNED'`, `planned_by = currentUser.id`
8. Entry erscheint in TeamÃ¼bersicht und Mitarbeiter-Kalender

**Edge Cases:**
- âœ… **Mitarbeiter ohne worker_id:** Backend verwendet `user_id` (Zeile 233-234)
- âš ï¸ **Admin wÃ¤hlt sich selbst:** Status wird trotzdem `PLANNED` (korrekt, da Admin auch bestÃ¤tigen kann)
- âŒ **Wizard-Select fehlt:** Fallback auf `currentUser.id` (Zeile 9236) - **RISIKO:** Admin plant versehentlich fÃ¼r sich selbst

**Data Integrity Risiken:**
- âš ï¸ **Keine Validierung:** Frontend prÃ¼ft nicht, ob `wizard-user` Select existiert, bevor gespeichert wird
- âœ… **Backend-Validierung:** Backend prÃ¼ft AuthZ (Zeile 243-256)

**Audit Trail:**
- âœ… `planned_by` wird gesetzt (Zeile 308, 338)
- âœ… `created_by` wird gesetzt (Zeile 339)
- âœ… `status = 'PLANNED'` wird gesetzt (Zeile 307)

---

### Workflow 2: Mitarbeiter bestÃ¤tigt Tag

**Happy Path:**
1. Mitarbeiter Ã¶ffnet Day View
2. Day View zeigt PLANNED Entries
3. Mitarbeiter klickt "Geplante Zeiten bestÃ¤tigen"
4. Frontend ruft `POST /api/time_entries/confirm_day` mit `{date: 'YYYY-MM-DD'}` auf
5. Backend `handleConfirmDay()` findet alle PLANNED Entries fÃ¼r diesen User an diesem Tag
6. Backend setzt `status = 'CONFIRMED'`, `confirmed_at = NOW()`, `confirmed_by = currentUser.id`
7. Frontend lÃ¤dt Entries neu (`loadTimeEntries()`)
8. Day View zeigt aktualisierte `confirmedHours`

**Edge Cases:**
- âœ… **Keine PLANNED Entries:** `updated_count = 0`, keine Fehlermeldung (korrekt)
- âš ï¸ **Admin bestÃ¤tigt fÃ¼r sich selbst:** Funktioniert (Zeile 25-42 prÃ¼ft `currentUser`, nicht Rolle)
- âŒ **BestÃ¤tigung nach Tagwechsel:** Wenn `date` in der Vergangenheit liegt, wird trotzdem bestÃ¤tigt (keine Validierung)

**Data Integrity Risiken:**
- âœ… **Backend-Validierung:** Nur eigene Entries kÃ¶nnen bestÃ¤tigt werden (Zeile 35-42)
- âš ï¸ **Keine Status-Validierung:** Backend prÃ¼ft nicht, ob Entry bereits `CONFIRMED` ist (kÃ¶nnte doppelt bestÃ¤tigt werden - **RISIKO**)

**Audit Trail:**
- âœ… `confirmed_at` wird gesetzt (Zeile 48)
- âœ… `confirmed_by` wird gesetzt (Zeile 49)
- âœ… `updated_by` wird gesetzt (Zeile 50)

---

### Workflow 3: Kategorien/AktivitÃ¤ten Summen

**Happy Path:**
1. Day View lÃ¤dt Entries fÃ¼r Tag
2. `renderDayView()` filtert Entries nach `activeDayUserId` (Zeile 2931-2942)
3. `computeHours()` berechnet Stunden pro Entry (Zeile 2945-2961)
4. `categoryTotals` aggregiert pro Kategorie (Zeile 2970-2976)
5. UI zeigt Summen pro Kategorie

**Edge Cases:**
- âŒ **Tag-Ãœbergang:** `computeHours()` berechnet 23:00-01:00 falsch (negativ)
- âš ï¸ **Fehlende time_from/time_to:** Fallback auf `entry.hours` (Zeile 2960) - **RISIKO:** Wenn `hours`-Feld falsch ist, wird falsche Summe angezeigt
- âš ï¸ **Kategorien ohne Stunden:** Werden trotzdem angezeigt (Zeile 3032-3054 prÃ¼ft nur `Object.keys(categoryTotals).length > 0`)

**Data Integrity Risiken:**
- âŒ **Inkonsistente Berechnung:** Day View verwendet `computeHours()` (ohne Tag-Ãœbergang), Backend verwendet `calculateHours()` (mit Tag-Ãœbergang)
- âš ï¸ **Keine Validierung:** Frontend prÃ¼ft nicht, ob `entry.hours` mit `time_from/time_to` Ã¼bereinstimmt

---

### Workflow 4: Overlap-Validierung

**Happy Path:**
1. User erstellt neuen Entry (Wizard oder direkt)
2. Frontend `validateTimeEntry()` prÃ¼ft Overlaps (Zeile 7993-8017)
3. Wenn Overlap: Alert, Speichern verhindert
4. Wenn kein Overlap: Backend wird aufgerufen
5. Backend prÃ¼ft erneut Overlaps (Zeile 264-304)
6. Wenn Overlap: 409 Conflict
7. Wenn kein Overlap: Entry wird gespeichert

**Edge Cases:**
- âŒ **Tag-Ãœbergang:** Frontend `calculateDuration()` gibt 0 zurÃ¼ck (Zeile 7980), Overlap-Check funktioniert nicht
- âœ… **Mehrere User parallel:** Backend prÃ¼ft nur pro `worker_id`/`created_by` (korrekt)
- âš ï¸ **Update mit Overlap:** Backend prÃ¼ft korrekt (Zeile 417-464), aber Frontend-Validierung kÃ¶nnte fehlschlagen

**Data Integrity Risiken:**
- âŒ **Frontend-Validierung unzuverlÃ¤ssig:** Bei Tag-Ãœbergang wird Overlap nicht erkannt
- âœ… **Backend-Validierung zuverlÃ¤ssig:** Backend prÃ¼ft korrekt

---

### Workflow 5: TeamÃ¼bersicht vs Einzelkalenderansicht

**Happy Path:**
1. Admin Ã¶ffnet "Ãœbersicht"
2. Frontend ruft `GET /api/admin/overview/week` auf
3. Backend aggregiert alle Entries fÃ¼r alle User
4. Frontend zeigt Grid mit Stunden pro User pro Tag
5. Admin klickt Zelle
6. Frontend setzt `uiState.calendarViewUserId = userId` (Zeile 2250)
7. Frontend wechselt zu Day View
8. `loadTimeEntries()` verwendet `getCalendarViewUserId()` (Zeile 8234)
9. Day View zeigt nur Entries fÃ¼r diesen User

**Edge Cases:**
- âš ï¸ **Admin Overview filtert nur nach worker_id:** Entries ohne `worker_id` (nur `created_by`) werden nicht angezeigt (Zeile 73-74 in `admin_overview.php`)
- âœ… **Einzelkalenderansicht funktioniert:** `loadTimeEntries()` verwendet `calendarViewUserId` korrekt

**Data Integrity Risiken:**
- âŒ **UnvollstÃ¤ndige Overview:** Entries ohne `worker_id` fehlen in TeamÃ¼bersicht

---

### Workflow 6: Projekt-Details Anzeige

**Happy Path:**
1. User wÃ¤hlt Projekt im Wizard
2. `renderProjectDetailsBox(loc)` wird aufgerufen (Zeile 8784)
3. Projekt-Details werden angezeigt

**Edge Cases:**
- âš ï¸ **Fehlende Felder:** `renderProjectDetailsBox()` zeigt "â€”" fÃ¼r fehlende Felder (korrekt)
- âœ… **Konsistenz:** Gleiche Funktion wird in Baustellenverwaltung verwendet (Single Source)

**Data Integrity Risiken:**
- âœ… **Niedrig:** Nur Anzeige, keine DatenÃ¤nderung

---

## PHASE 5 â€” API & BACKEND KONSISTENZ

### Endpoint-Ãœbersicht

| Endpoint | Method | Request Fields | Response Fields | AuthZ |
|----------|--------|----------------|-----------------|-------|
| `POST /api/time_entries/confirm_day` | POST | `{date: 'YYYY-MM-DD'}` | `{ok: true, date, updated_count}` | Self-only |
| `GET /api/time_entries` | GET | `?user_id=`, `?worker_id=`, `?date_from=`, `?date_to=`, `?status=` | `{success: true, data: [...]}` | Admin: all, Worker: own |
| `POST /api/time_entries` | POST | `{entry_date, time_from, time_to, worker_id?, user_id?, category, location_id?, notes?, status?}` | `{success: true, id}` | Admin: any, Worker: self |
| `PUT /api/time_entries/:id` | PUT | `{entry_date?, time_from?, time_to?, category?, location_id?, notes?, status?}` | `{success: true}` | Admin: all, Worker: own |
| `DELETE /api/time_entries/:id` | DELETE | - | `{success: true}` | Admin-only |
| `POST /api/time_entries/:id/confirm` | POST | - | `{success: true}` | Self-only |
| `POST /api/time_entries/:id/reject` | POST | - | `{success: true}` | Self-only |
| `GET /api/admin/overview/week` | GET | `?date_from=`, `?date_to=` | `{ok: true, users: [...], entries: [...], data: [...]}` | Admin-only |

### Feldnamen-Konsistenz

**Backend â†’ Frontend Normalisierung:**
- `backend/api/time_entries.php:196-203`: Backend normalisiert `worker_id` â†’ `workerId`, `time_from` â†’ `timeFrom`, etc.
- âœ… **Konsistent:** Frontend verwendet camelCase, Backend liefert beide Formate

**Status-Codes:**
- âœ… **Konsistent:** 409 fÃ¼r Overlap, 403 fÃ¼r Permission Denied, 401 fÃ¼r Unauthorized

**Fehlermeldungen:**
- âš ï¸ **Uneinheitlich:** Backend verwendet `{ok: false, error: '...'}` (confirm_day) vs `{success: false, error: '...'}` (andere Endpoints)
- âš ï¸ **Frontend erwartet:** `response.ok` (Zeile 2400) vs `response.success` (andere Stellen)

---

## PHASE 6 â€” REPORTING / ZAHLENWAHRHEIT

### Stunden-Berechnung: Single Source of Truth?

**Aktueller Zustand:**
- âŒ **KEIN Single Source of Truth**
- Backend: `calculateHours()` (mit Tag-Ãœbergang)
- Frontend Day View: `computeHours()` (ohne Tag-Ãœbergang)
- Frontend Week View: `minutesBetween()` (mit Date-Objekten)

**Empfehlung:**
- **Backend `calculateHours()` als Single Source of Truth** verwenden
- Frontend sollte **immer** `entry.hours` aus Backend verwenden, nicht neu berechnen
- Nur wenn `entry.hours` fehlt, Frontend-Berechnung als Fallback (mit Tag-Ãœbergang)

**Aktuelle Inkonsistenzen:**
- Day View berechnet Stunden neu (Zeile 2945-2961) statt `entry.hours` zu verwenden
- Week View berechnet Stunden neu (Zeile 4752) statt `entry.hours` zu verwenden
- Admin Overview verwendet `entry.hours` (korrekt)

**Risiko:**
- **Kritisch:** Wenn Backend `hours`-Feld manuell geÃ¤ndert wird, zeigen Day/Week View andere Zahlen als Overview

---

### Tages-Summe Berechnung

**Day View (`app.js:2963`):**
```javascript
const dayTotal = dayTimeEntries.reduce((sum, entry) => sum + computeHours(entry), 0);
```
- âŒ Verwendet `computeHours()` (ohne Tag-Ãœbergang)
- âŒ Berechnet neu statt `entry.hours` zu verwenden

**Week View (`app.js:4747-4766`):**
```javascript
let hours = parseFloat(entry.hours);
if (!hours || isNaN(hours)) {
  if (entry.time_from && entry.time_to) {
    const minutes = minutesBetween(entry.time_from, entry.time_to);
    hours = minutes / 60;
  }
}
```
- âœ… Verwendet `entry.hours` als PrimÃ¤rquelle
- âœ… Fallback auf `minutesBetween()` nur wenn `hours` fehlt

**Admin Overview (`backend/api/admin_overview.php:92`):**
```php
$hours = (float)$entry['hours'];
```
- âœ… Verwendet `entry.hours` direkt

**Fazit:**
- **Inkonsistenz:** Day View berechnet neu, Week View und Overview verwenden `entry.hours`
- **Empfehlung:** Day View sollte auch `entry.hours` verwenden (mit Fallback)

---

### Confirmed-Summe Berechnung

**Day View (`app.js:2964-2966`):**
```javascript
const confirmedHours = dayTimeEntries
  .filter(entry => entry.status === 'CONFIRMED')
  .reduce((sum, entry) => sum + computeHours(entry), 0);
```
- âŒ Verwendet `computeHours()` statt `entry.hours`

**Week View (`app.js:4763-4765`):**
```javascript
if (status === 'CONFIRMED') {
  weekConfirmed += hours; // hours aus entry.hours oder minutesBetween()
}
```
- âœ… Verwendet `entry.hours` (oder berechnete hours)

**Admin Overview (`backend/api/admin_overview.php:97-99`):**
```php
} elseif ($entry['status'] === 'CONFIRMED') {
    $days[$day]['confirmed'] += $hours; // hours aus entry.hours
}
```
- âœ… Verwendet `entry.hours`

**Fazit:**
- **Inkonsistenz:** Day View berechnet neu, andere verwenden `entry.hours`
- **Empfehlung:** Day View sollte `entry.hours` verwenden

---

## PHASE 7 â€” RISIKO-MATRIX

### ğŸ”´ CRITICAL (Muss sofort behoben werden)

| # | Symptom | Ursache | Beleg | Auswirkung | Empfohlener Fix |
|---|---------|---------|-------|------------|-----------------|
| 1 | **Datenleck in Admin Overview** | Overview filtert nur nach `worker_id`, ignoriert `created_by`-Entries | `backend/api/admin_overview.php:73-74` | Admin sieht nicht alle Entries, unvollstÃ¤ndige Ãœbersicht | Filter erweitern: `WHERE (worker_id = ? OR created_by = ?)` |
| 2 | **Falsche Stunden-Berechnung bei Tag-Ãœbergang** | `computeHours()` behandelt Tag-Ãœbergang nicht | `app.js:2945-2961` | Nacht-Schichten werden falsch berechnet, falsche Summen | `computeHours()` erweitern um Tag-Ãœbergang-Logik ODER `entry.hours` verwenden |
| 3 | **Inkonsistente Zahlen zwischen Views** | Day View berechnet Stunden neu, Overview verwendet `entry.hours` | `app.js:2963` vs `admin_overview.php:92` | Admin sieht unterschiedliche Zahlen in Overview vs Day View | Day View sollte `entry.hours` verwenden (mit Fallback) |

### ğŸŸ  HIGH (Sollte bald behoben werden)

| # | Symptom | Ursache | Beleg | Auswirkung | Empfohlener Fix |
|---|---------|---------|-------|------------|-----------------|
| 4 | **Doppelte User-Identifikation** | Drei verschiedene Wege (`worker_id`, `user_id`, `created_by`) | `backend/api/time_entries.php` (mehrere Stellen) | Inkonsistente Filter, mÃ¶gliche Datenlecks | Konsolidierung: Immer `worker_id` bevorzugen, `created_by` nur als Fallback dokumentieren |
| 5 | **Frontend Overlap-Validierung unzuverlÃ¤ssig** | `calculateDuration()` behandelt Tag-Ãœbergang nicht | `app.js:7976-7982` | Frontend erkennt Overlaps bei Nacht-Schichten nicht | `calculateDuration()` erweitern um Tag-Ãœbergang ODER nur Backend-Validierung verwenden |
| 6 | **Verwirrende doppelte Funktionen** | `getActiveCalendarUserId()` und `getCalendarViewUserId()` fast identisch | `app.js:2463-2470` vs `2472-2478` | Code-Duplikation, Wartungsaufwand | Konsolidierung: Eine Funktion entfernen, alle Verwendungen auf eine umstellen |

### ğŸŸ¡ MEDIUM (Sollte behoben werden)

| # | Symptom | Ursache | Beleg | Auswirkung | Empfohlener Fix |
|---|---------|---------|-------|------------|-----------------|
| 7 | **Uneinheitliche Response-Formate** | `confirm_day` verwendet `{ok: ...}`, andere `{success: ...}` | `backend/api/time_entries.php:60` vs andere Endpoints | Frontend muss beide Formate handhaben | Vereinheitlichung: Alle Endpoints sollten `{success: ...}` verwenden |
| 8 | **Veraltete `selectedUserId` Variable** | `selectedUserId` wird noch verwendet, aber `calendarViewUserId` ist aktuell | `app.js:300, 1995, 2004, 2006` | Code-Verwirrung | Konsolidierung: Alle Verwendungen von `selectedUserId` auf `calendarViewUserId` umstellen |
| 9 | **Fehlender Audit-Trail fÃ¼r REJECTED** | `handleRejectTimeEntry()` setzt kein `rejected_at`/`rejected_by` | `backend/api/time_entries.php:577` | Keine Nachvollziehbarkeit wer/wann abgelehnt hat | Spalten `rejected_at`, `rejected_by` hinzufÃ¼gen und setzen |

### ğŸŸ¢ LOW (Kann spÃ¤ter behoben werden)

| # | Symptom | Ursache | Beleg | Auswirkung | Empfohlener Fix |
|---|---------|---------|-------|------------|-----------------|
| 10 | **Keine Validierung bei confirm_day** | Backend prÃ¼ft nicht, ob Entry bereits CONFIRMED ist | `backend/api/time_entries.php:32` | Doppelte BestÃ¤tigung mÃ¶glich (harmlos, aber ineffizient) | WHERE-Bedingung erweitern: `AND status = 'PLANNED'` (bereits vorhanden âœ…) |
| 11 | **Wizard-Select Fallback** | Wenn `wizard-user` Select fehlt, wird `currentUser.id` verwendet | `app.js:9236` | Admin kÃ¶nnte versehentlich fÃ¼r sich selbst planen | Validierung: Wenn Admin, muss Select existieren |

---

## PHASE 8 â€” ERP READINESS SCORE

### Bewertungskriterien (0-100 Punkte)

| Kriterium | Gewicht | Score | BegrÃ¼ndung |
|-----------|---------|-------|------------|
| **Single Source of Truth** | 25% | 40/100 | âŒ Drei verschiedene Stunden-Berechnungen, doppelte User-Identifikation |
| **Konsistente Datenlogik** | 20% | 50/100 | âš ï¸ Teilweise konsistent, aber Inkonsistenzen bei Filter-Logik |
| **Workflow-IntegritÃ¤t** | 20% | 70/100 | âœ… Workflows funktionieren, aber Edge Cases nicht vollstÃ¤ndig abgedeckt |
| **API-Konsistenz** | 15% | 60/100 | âš ï¸ Uneinheitliche Response-Formate, aber grundsÃ¤tzlich RESTful |
| **Reporting-Zahlenwahrheit** | 20% | 50/100 | âŒ Inkonsistente Berechnungen zwischen Views |

**Gesamt-Score: 62/100**

### BegrÃ¼ndung

**StÃ¤rken:**
- âœ… Grundlegende ERP-FunktionalitÃ¤t vorhanden (Status-Workflow, Audit-Trail teilweise)
- âœ… Backend-Validierung robust (Overlap, AuthZ)
- âœ… Workflows funktionieren im Happy Path

**SchwÃ¤chen:**
- âŒ Keine Single Source of Truth fÃ¼r Stunden-Berechnung
- âŒ Inkonsistente User-Identifikation (worker_id vs user_id vs created_by)
- âŒ Zahlenabweichungen zwischen Views mÃ¶glich
- âŒ Frontend-Validierung unzuverlÃ¤ssig (Tag-Ãœbergang)

**ERP-Tauglichkeit:**
- âš ï¸ **Teilweise ERP-tauglich:** FÃ¼r grundlegende Zeiterfassung geeignet, aber nicht fÃ¼r prÃ¤zise Abrechnung ohne Fixes
- âŒ **Nicht abrechnungsreif:** Zahlenabweichungen zwischen Views sind kritisch fÃ¼r Abrechnung

---

## PHASE 9 â€” PRIORISIERTE ROADMAP

### Top 10 Fixes (PrioritÃ¤t: Critical â†’ High â†’ Medium)

1. **ğŸ”´ CRITICAL: Admin Overview Datenleck fixen**
   - Datei: `backend/api/admin_overview.php:73-74`
   - Fix: Filter erweitern um `created_by`-Entries
   - Aufwand: ~30 Min

2. **ğŸ”´ CRITICAL: Stunden-Berechnung konsolidieren**
   - Datei: `app.js:2945-2961` (Day View)
   - Fix: `entry.hours` verwenden statt `computeHours()`, Fallback nur wenn `hours` fehlt
   - Aufwand: ~1h

3. **ğŸ”´ CRITICAL: Tag-Ãœbergang in `computeHours()` fixen**
   - Datei: `app.js:2945-2961`
   - Fix: Tag-Ãœbergang-Logik hinzufÃ¼gen (wie Backend `calculateHours()`)
   - Aufwand: ~30 Min

4. **ğŸŸ  HIGH: User-Identifikation konsolidieren**
   - Dateien: `backend/api/time_entries.php` (mehrere Stellen)
   - Fix: Immer `worker_id` bevorzugen, `created_by` nur als Fallback dokumentieren
   - Aufwand: ~2h

5. **ğŸŸ  HIGH: Frontend Overlap-Validierung fixen**
   - Datei: `app.js:7976-7982`
   - Fix: `calculateDuration()` erweitern um Tag-Ãœbergang ODER nur Backend-Validierung verwenden
   - Aufwand: ~1h

6. **ğŸŸ  HIGH: Doppelte Funktionen konsolidieren**
   - Dateien: `app.js:2463-2470`, `app.js:2472-2478`
   - Fix: `getActiveCalendarUserId()` entfernen, alle Verwendungen auf `getCalendarViewUserId()` umstellen
   - Aufwand: ~1h

7. **ğŸŸ¡ MEDIUM: Response-Formate vereinheitlichen**
   - Datei: `backend/api/time_entries.php:60`
   - Fix: `{ok: ...}` â†’ `{success: ...}` Ã¤ndern, Frontend anpassen
   - Aufwand: ~1h

8. **ğŸŸ¡ MEDIUM: `selectedUserId` entfernen**
   - Dateien: `app.js:300, 1995, 2004, 2006`
   - Fix: Alle Verwendungen auf `calendarViewUserId` umstellen
   - Aufwand: ~1h

9. **ğŸŸ¡ MEDIUM: Audit-Trail fÃ¼r REJECTED**
   - Datei: `backend/api/time_entries.php:577`
   - Fix: Spalten `rejected_at`, `rejected_by` hinzufÃ¼gen (Migration), setzen in `handleRejectTimeEntry()`
   - Aufwand: ~2h

10. **ğŸŸ¢ LOW: Wizard-Select Validierung**
    - Datei: `app.js:9235-9239`
    - Fix: Validierung: Wenn Admin, muss `wizard-user` Select existieren
    - Aufwand: ~30 Min

---

## ANHANG: CODE-REFERENZEN

### Kritische Stellen (fÃ¼r schnelle Navigation)

- **Admin Overview Datenleck:** `backend/api/admin_overview.php:73-74`
- **Stunden-Berechnung Day View:** `app.js:2945-2961`
- **Stunden-Berechnung Backend:** `backend/api/time_entries.php:589-602`
- **User-Identifikation Filter:** `backend/api/time_entries.php:140-149`
- **Overlap-Validierung Frontend:** `app.js:7993-8017`
- **Overlap-Validierung Backend:** `backend/api/time_entries.php:264-295`
- **Doppelte Funktionen:** `app.js:2463-2470` vs `2472-2478`

---

**Ende des Reports**

